## **基于时空图神经网络的申万一级行业轮动单因子（动量）策略研究与实现**

**版本: 1.0**
**日期: 2025年11月25日**

### **摘要 (Abstract)**

本项目旨在设计、实现并评估一个基于深度学习的量化交易策略，专注于中国A股市场的申万一级（SW L1）行业指数轮动。策略的核心是一个创新的时空图神经网络模型（Spatio-Temporal Graph Neural Network），该模型结合了图注意力网络（GAT）和门控循环单元（GRU），旨在同时捕捉行业间的复杂关联性（空间维度）和各行业自身的时间序列动态（时间维度）。

我们首先构建了以相对强度（Jd-Ratio）和相对动量（Jd-Momentum）为核心的RRG风格因子体系。随后，设计并实现了`Stacked_GRU_GAT_Predictor_rg`模型，通过堆叠时空模块（`SpatioTemporalBlock`）和多尺度GRU（`MultiScaleGRU`）来深度挖掘市场数据中的非线性模式。为了保证模型的时效性和适应性，我们采用了滚动训练（Walk-Forward Training）的方法论，定期对模型进行增量微调。

最终，基于模型生成的预测因子，我们构建了一个等权重投资组合，并在一个贴近真实交易的回测框架中进行了严格的绩效评估。回测框架考虑了交易成本，并采用了周五收盘价交易的模式，以规避周末跳空风险。本报告将详细阐述从数据准备、模型设计、训练流程到策略回测的全过程，并对结果进行分析。

---

### **1. 引言 (Introduction)**

#### **1.1. 研究背景与动机**

行业轮动是主动投资中获取超额收益（Alpha）的重要来源。然而，随着市场有效性的增强和信息的快速传播，传统的线性模型或基于经验的规则在捕捉行业轮动规律时面临越来越大的挑战。行业间的相互影响、宏观经济的传导效应以及市场情绪的共振，共同构成了一个高维度、非线性的复杂系统。

深度学习，特别是图神经网络（GNN）和循环神经网络（RNN），为解决此类问题提供了新的范式。将行业生态视为一个动态演化的图结构，其中每个行业是一个节点，行业间的关系是边，这种方法能够更自然地对市场进行建模。本项目正是基于这一动机，探索利用前沿的时空图神经网络技术，构建一个数据驱动的行业轮动策略。

#### **1.2. 项目目标**

1.  **构建行业因子体系**：基于相对强弱理论（RRG），构建适用于申万一级行业的动态因子库。
2.  **设计时空预测模型**：开发一个能够同时处理行业截面数据和时间序列数据的深度学习模型，以预测未来一周的因子表现。
3.  **建立滚动训练框架**：实现一个自动化的滚动训练（Walk-Forward）流程，确保模型能够持续学习新的市场模式。
4.  **开发严谨的回测系统**：构建一个考虑交易成本和现实执行约束的量化回测框架，并对策略表现进行客观评估。

---

### **2. 数据与特征工程**

#### **2.1. 数据源**

*   **行情数据**：申万一级行业指数的日度开盘价、收盘价、成交额等。
*   **基准数据**：沪深300指数（000300.SH）的日度行情，用于计算相对因子和作为业绩比较基准。
*   **无风险利率**：国债或货币基金（如 `511010.SH`）作为备选池和计算夏普比率的参考。

#### **2.2. 核心特征构建 (RRG风格因子)**

为了捕捉行业的相对表现，我们构建了两个核心因子，其思想源于相对强弱图（RRG）：

1.  **相对强度 (Jd-Ratio)**：衡量单个行业相对于市场基准（沪深300）的强弱趋势。
    $$
    \text{Ratio}_t = \frac{\text{IndexPrice}_t / \text{BenchmarkPrice}_t}{\text{SMA}(\text{IndexPrice} / \text{BenchmarkPrice}, N)} \times 100
    $$
    其中，SMA为N日简单移动平均。该因子反映了行业表现是否跑赢市场大盘。

2.  **相对动量 (Jd-Momentum)**：衡量相对强度（Ratio）自身的变化速度，即动量。
    $$
    \text{Momentum}_t = \frac{\text{Ratio}_t}{\text{SMA}(\text{Ratio}, N)} \times 100
    $$
    该因子反映了行业跑赢大盘的趋势是在加速还是在减速。

这两个因子共同构成了描述行业在轮动周期中所处位置的关键特征。

---

### **3. 模型架构 (`GAT_GRU_pro.py`)**

为了有效捕捉行业轮动的时空特性，我们设计了 **`Stacked_GRU_GAT_Predictor_rg`** 模型。该模型的核心思想是将市场视为一个全连接图，其中每个行业是一个节点，模型在每个时间步学习行业的时空联合表示。

#### **3.1. 核心组件**

1.  **`TimeAwareGATLayer` (时间感知图注意力层)**
    *   **功能**：作为模型的核心空间处理单元。它使用图注意力机制（GAT）来学习不同行业之间的动态影响权重。
    *   **创新点**：与标准GAT不同，本层在计算注意力权重时，不仅考虑了节点的静态特征，还融入了由GRU处理过的时间序列信息，使得图的结构和权重能够感知时间动态。

2.  **`MultiScaleGRU` (多尺度门控循环单元)**
    *   **功能**：作为模型的核心时间处理单元。它并行使用多个具有不同循环核尺寸的GRU，以捕捉不同时间尺度上的序列依赖关系。
    *   **优势**：能够同时关注短期的快速变化和长期的慢速趋势，增强了模型对复杂时间模式的建模能力。

3.  **`SpatioTemporalBlock` (时空模块)**
    *   **功能**：将`TimeAwareGATLayer`和`MultiScaleGRU`有机结合的基础模块。
    *   **流程**：输入的时间序列首先通过`MultiScaleGRU`提取时间特征，然后将原始输入和时间特征一同送入`TimeAwareGATLayer`进行空间信息聚合。模块内部包含残差连接（Residual Connection）和层归一化（LayerNorm），以保证信息流的稳定和训练的高效性。

#### **3.2. 整体架构 (`Stacked_GRU_GAT_Predictor_rg`)**

模型整体采用堆叠式设计，以增强表示学习的深度。

1.  **输入处理**：原始的因子序列（如Ratio, Momentum）首先经过一个线性层映射到高维空间。
2.  **时空堆叠**：数据流经多个串联的`SpatioTemporalBlock`。每一层都在前一层的基础上，进一步提炼时空特征。
3.  **自回归预测**：模型引入了一个创新的门控自回归机制。它不仅使用历史数据进行预测，还将模型上一期的预测值作为下一期预测的输入之一。一个可学习的门控参数`lambda`动态地平衡了历史真实值和模型自生成值在预测中的贡献，增强了模型在多步预测中的稳定性和一致性。
4.  **输出层**：最后，通过N个全连接层（MLP）将高维特征解码，使用生成式预测，输出对未来N周`Jd-Ratio`和`Jd-Momentum`的预测值。

---

### **4. 训练流程 (`train_sw1_rolling.py`)**

为了让模型适应不断变化的市场环境，我们采用了 **滚动训练(Walk-Forward Training)** 的范式，而非一次性训练。

#### **4.1. 滚动机制**

1.  **初始化训练**：使用一个较长的初始历史数据窗口（例如，2015-2020年）对模型进行首次完整训练。
2.  **滚动预测与微调**：
    *   **预测步**：使用当前训练好的模型，向前预测未来一段时间（例如，一个季度）的因子值。
    *   **数据步进**：将预测过的时间段的数据纳入训练集。
    *   **模型微调（Fine-tuning）**：在更新后的训练集上，对模型进行少量轮次（Epochs）的微调，而不是从头开始训练。
3.  **循环**：重复执行“预测步”和“微调步”，直到所有回测期的数据都被预测完毕。

#### **4.2. 训练细节**

*   **损失函数**：使用均方误差（MSE Loss）作为损失函数，衡量预测因子与真实因子之间的差距。
*   **优化器**：采用AdamW优化器，它在Adam的基础上加入了权重衰减（Weight Decay）的修正，有助于防止过拟合。
*   **学习率调度**：使用`ReduceLROnPlateau`调度器，当验证集损失在一定周期内不再下降时，自动降低学习率，以实现更精细的收敛。

---

### **5. 回测框架与策略 (`backtest_sw1.py`)**

一个可靠的回测框架是检验策略有效性的基石。我们构建的`BackTest`类旨在模拟一个贴近现实的交易过程。

#### **5.1. 交易逻辑**

1.  **执行假设**：策略采用**周五收盘价**进行交易。这意味着，在每周五收盘时，我们根据模型截至当日的最新预测，计算出下周应持有的投资组合，并立即以收盘价完成调仓。
    *   **合理性**：这个假设模拟了在收盘前（如最后30分钟）或利用收盘集合竞价进行交易的真实场景，有效规避了周末的价格跳空风险，是比“下周一开盘价交易”更积极、也更稳健的方案。

2.  **信号生成**：
    *   在每个周五，我们获取模型在上个周五对本周五的`Jd-Ratio`和`Jd-Momentum`的预测值。
    *   **选股条件 (`combined_condition3`)**：策略的核心选股逻辑是寻找“预期进入强势区”的行业。具体条件为：
        *   预测的`Jd-Ratio`和`Jd-Momentum`在所有行业中排名前列（例如，`rank_start_p`到`rank_end_p`之间）。
        *   预测的`Jd-Ratio`和`Jd-Momentum`的周度变化量也排名前列，且为正数。
    *   这个逻辑旨在筛选出那些不仅预期状态良好，而且预期趋势正在改善的行业。

3.  **投资组合构建**：
    *   将所有满足上述条件的行业筛选出来。
    *   对选中的行业采用 **等权重(Equal Weight)** 分配资金。
    *   如果当周没有任何行业被选中，则**空仓**或持有无风险资产（如债券类ETF）。

#### **5.2. 收益计算与成本**

*   **收益计算**：策略的周度收益由上周五持有的投资组合在本周的周度收益率（基于周五收盘价到下周五收盘价计算）决定。
*   **交易成本**：在回测中，我们设置了买入和卖出费率（例如，`buy_rate=0.003`, `sell_rate=0.003`）。每次调仓时，换手部分的市值会按比例扣除成本，直接反映在策略的净值曲线上。

#### **5.3. 绩效评估**

回测结束后，系统会生成一系列详细的绩效指标，包括：

*   **收益指标**：累计收益、年化收益、超额收益。
*   **风险指标**：年化波动率、最大回撤、Beta。
*   **风险调整后收益**：夏普比率、卡尔玛比率、索提诺比率、Alpha、信息比率。
*   **交易行为指标**：年化换手率、总交易成本、成本对收益影响分析。

这些指标共同构成了一个对策略全方位的立体评估。

---

### **6. 结论与展望**

本项目完整地实现了从数据处理、模型构建、滚动训练到策略回测的全链路量化研究流程。通过引入先进的时空图神经网络模型，我们尝试从更高维度理解并预测行业轮动。

初步的回测结果表明，在考虑了现实的交易约束和成本后，本策略展现了获取超额收益的潜力。

**未来可行的改进方向包括：**

1.  **丰富因子维度**：在现有RRG因子的基础上，引入更多宏观、估值、资金流、拥挤度等因子，为模型提供更全面的信息。
2.  **优化策略逻辑**：探索更复杂的投资组合优化方法（如最小方差、风险平价），替代当前的等权重方案。
3.  **改进模型结构**：尝试更先进的图网络结构，或将Transformer等注意力机制融入到时间序列处理中。
4.  **多频率融合**：研究如何将日线级别的高频信号与周线级别的趋势信号进行有效融合。

---
*此文档由 Gemini 2.5 Pro 生成*